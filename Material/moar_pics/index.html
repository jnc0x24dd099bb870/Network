<!DOCTYPE html>
<html>
<body bgcolor="#28282B" text="#5f9ea0" link="#00BFFF" vlink="#00BFFF"> 



<head>


<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  margin: 0;
  font-family: "Times New Roman", Times, serif;
}

.topnav {
  overflow: hidden;
  background-color: #333;
}

.topnav a {
  float: left;
  color: #f2f2f2;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
  font-size: 17px;
}

.topnav a:hover {
  background-color: #ddd;
  color: black;
}

.topnav a.active {
  background-color: #4CAF50;
  color: white;
}

div {
  border: 1px solid black;
  background-color: black;
  padding-top: 50px;
  padding-bottom: 50px;
  padding-left: 90px;
  padding-right: 90px;
}

</style>
</head>
<body>

<div class="topnav">
  <a href="#home">Home</a>
  <a href="https://isaac-exe.gitbook.io/various-tutorials/">Gitbook</a>
  <a href="#about">About</a>
</div>

</br>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Integrating Ansible with Terraform for deploying and configuring OCI instances</h1>
  <br>
  </br>
  
  </br>
  <span class="post-date"><i>This is a personal blog. All views are my own.</i></span>
  </br></br>
  </br></br>
  
<i> backing up this stuff here, work in progress. </i>


  <p>This tutorial is intended to explain how to use Terraform and Ansible for OCI deployment and services configuration.<br>

It consists mainly in three parts: <br>
<br>
- how to integrate ansible and terraform<br>
- how to prepare your local environment for further changes on the remote hosts<br>
- testing your new OCI environment with MySQL master-slave replication <br>
<br>



<br><br>
<h2> Before proceeding... </h2>
<br><br>
In this tutorial, we will deploy two instances of same configuration, while configuring MySQL service with the help of Ansible<br>

 Folder content:
 
 <figure class="highlight">
 <pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4;overflow-y:scroll">
 <code class="language-bash" data-lang="bash">
 
 root@deploymentmachine:/home/Tutorial1# tree . -I '*.tfstate|*.backup'
.
├── ansible.cfg
├── compartment.tf
├── data.tf
├── dhcp_opt.tf
├── instance.tf
├── int_gateway.tf
├── mysql.yml
├── output.tf
├── provider.tf
├── remote.tf
├── replication.yml
├── route.tf
├── run.sh
├── security_list.tf
├── subnet.tf
├── variables.tf
└── vcn.tf

0 directories, 17 files
 
 </code></pre></figure>


For this scenario,  our variables.tf file contains the default value 2 that is setup for variable instance_count:

<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">

root@deploymentmachine:/home/Tutorial1# more  variables.tf | grep -A3 instance_count

variable "instance_count" {
  default = 2
}
</code>
</pre>
</figure>

<h3>Discussions </h3>

<b>Networking discussion </b> <br>
<br>

Considering we have  we have to deploy multiple instances (or in this scenario, a couple of instances),  it is necessary to provide to each instance an IP address (in this scenario, a public IP Address): <br>

The configuration file "instance.tf" contains the details for declaring the public IP.<br>

Under the  resource "oci_core_instance", the public IP address is assigned  with the help of object create_vnic_details :<br><br>

<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">
root@deploymentmachine:/home/Tutorial1# more  instance.tf | grep -A4 create_vnic_details
    create_vnic_details {
        assign_public_ip = true
        subnet_id = oci_core_subnet.MySQLSubnet.id
    }
</code>
</pre>
</figure>

<figure class="highlight">
<pre style="-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<code class="language-bash" data-lang="bash">
, where:

create_vnic_details - Contains properties for a VNIC.
Object used when creating the primary VNIC during instance launch or when creating a secondary VNIC. 

With create_vnic_details properties:
 
assign_public_ip -  the VNIC should be assigned a public IP address. 
subnet_id -  The OCID of the subnet to create the VNIC in. 

</code>
</pre>
</figure>


The file data.tf is defining data sources for obtaining the vnic attachment for each instance, along with the vnic_id from the primary VNIC of each instance:

<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">
 data "oci_core_vnic_attachments" "MySQLVNICs" {
       count = var.instance_count
       compartment_id = oci_identity_compartment.MySQLCompartment.id
       availability_domain = var.available_dom
       instance_id = oci_core_instance.MySQLInstance[count.index].id
  }

# get the primary VNIC ID

  data "oci_core_vnic" "MySQLVNICprimary" {
     count = var.instance_count
     vnic_id = lookup(data.oci_core_vnic_attachments.MySQLVNICs[count.index].vnic_attachments[0], "vnic_id")
  }
</code>
</pre>
</figure>

<br>
<figure class="highlight">
<pre style="-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<code class="language-bash" data-lang="bash">
, where
oci_core_vnic_attachments - lists the VNIC attachments in the specified compartment
oci_core_vnic -  provides details about a specific Vnic resource in OCI Core service.
</code>
</pre>
</figure>


The MySQLVNICprimary data resource will be used to extract the public IP, in the remote.tf file: 
for variable host and running the local command for ansible-playbook:

<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">
resource "null_resource" "MySQLRemote" {

  count = var.instance_count
[ ... snip ... ]
   connection {
      [...]
      host = data.oci_core_vnic.MySQLVNICprimary[count.index].public_ip_address
      [...]
   }
 
 provisioner "local-exec" {

     command = "ansible-playbook -i '${data.oci_core_vnic.MySQLVNICprimary[count.index].public_ip_address},' --private-key ${var.private_key_path} mysql.yml  -u ubuntu"

   }
 }
</code>
</pre>
</figure>
 

Notice how "count" is declared everytime. <br><br>

Output when running "terraform plan"


<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">
  # data.oci_core_vnic.MySQLVNICprimary[0] will be read during apply
  # (config refers to values not yet known)
 <= data "oci_core_vnic" "MySQLVNICprimary"  {
      + availability_domain    = (known after apply)
      + compartment_id         = (known after apply)
      [...]
      + public_ip_address      = (known after apply)
      [...]
	 }
	 
   [ ... snip ... ]
   
  # data.oci_core_vnic.MySQLVNICprimary[1] will be read during apply
  # (config refers to values not yet known)
 <= data "oci_core_vnic" "MySQLVNICprimary"  {
      + availability_domain    = (known after apply)
      + compartment_id         = (known after apply)
      [...]
      + public_ip_address      = (known after apply)
      [...]
	 }
</code>
</pre>
</figure>


<b> Discussion on creating multiple instances </b>

As already mentioned, we are creating and configuring multiple instances of same configuration. 

<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">

root@deploymentmachine:/home/Tutorial1# more variables.tf | grep -E -A3 'instance_shape|instance_count'
variable "instance_shape" {
  default = "VM.Standard.E2.1"
}

--
variable "instance_count" {
  default = 2
}
</code>
</pre>
</figure>

To create multiple instances,define display_name object from oci_core_instance resource,  by incrementing the count(it starts from 0):

<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">
root@deploymentmachine:/home/Tutorial1#  more instance.tf | grep -E -A1 'resource|instance_count|display_name'
resource "oci_core_instance" "MySQLInstance" {

--
    count = var.instance_count

--
    display_name = "MySQL-${count.index}"

</code>
</pre>
</figure>

<br><br>
The output for "terraform plan":
<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">
 # oci_core_instance.MySQLInstance[0] will be created
  + resource "oci_core_instance" "MySQLInstance" {
      [...]
      + display_name                        = "MySQL-0"

 # oci_core_instance.MySQLInstance[1] will be created
  + resource "oci_core_instance" "MySQLInstance" {
      [...]
      + display_name                        = "MySQL-1"
	  
</code>
</pre>
</figure>

<br>
<br><br>
<h2> How to integrate ansible and terraform </h2>
<br><br>


Now that we a small idea about how terraform works when deploying multiple instances, let's see how we can configure a MySQL service with the help of Ansible.

For making Ansible work in Terraform, you need first of all to create an ansible configuration file:

<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">
root@deploymentmachine:/home/tests/terra/test10# more ansible.cfg
[defaults]

host_key_checking = False
interpreter_python = /usr/bin/python3
</code>
</pre>
</figure>

This file needs to be put in the same folder from where you will run the terraform commands.<br><br>
Do not forget to setup the host_key_checking as False (for avoiding ssh key checking when connecting to remote host), and interpreter_python (for module execution)<br>
<br>
As you already noticed in the previous discussions, the remote.tf file contains two provisioner blocks.


The first provisioner is "remote-exec"  - this provisioner will check (among others) the hostname, the python version, 
and will perform updates and configure the firewall on each host:

<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">
root@deploymentmachine:/home/Tutorial1# more remote.tf | grep -A19 remote-exec
  provisioner "remote-exec" {
    inline = ["echo I am in ",
              "hostname",
              "python3 --version",
              "sleep 10",
              "sudo apt update",
              "sudo apt install -y firewalld",
              "sleep 5",
              "sudo firewall-cmd --add-port=3306/tcp --permanent",
              "sudo firewall-cmd --add-port=33060/tcp --permanent",
              " sudo firewall-cmd --reload"]

    connection {
      type = "ssh"
      user = "ubuntu"
      host = data.oci_core_vnic.MySQLVNICprimary[count.index].public_ip_address
      private_key = file(var.private_key_path)
   }

  }
</code>
</pre>
</figure>

The second provisioner is "local-exec" - this Terraform provisioner will run the ansible-playbook command on your local machine, 
and connect to each recently deployed instance for configuring MySQL service with the help of mysql.yml playbook.

<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">

root@deploymentmachine:/home/Tutorial1# more remote.tf | grep -A4 local-exec
   provisioner "local-exec" {

     command = "ansible-playbook -i '${data.oci_core_vnic.MySQLVNICprimary[count.index].public_ip_address},'  --private-key ${var.private_key_path} mysql.yml  -u ubuntu"

   }
</code>
</pre>
</figure>

<br><br>
<b>Ansible output in Terraform after running "terraform apply"</b>

<p> A possible output for "local-exec" may look as below:
<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">

[.... snip .... ] 
 null_resource.MySQLRemote[1]: Provisioning with 'local-exec'...
 null_resource.MySQLRemote[1] (local-exec): 
 Executing: ["/bin/sh" "-c" "ansible-playbook -i '130.61.159.77,' --private-  key /root/.ssh/id_rsa mysql.yml  -u ubuntu"]

 null_resource.MySQLRemote[1] (local-exec): PLAY [all]   
************************************

 null_resource.MySQLRemote[1] (local-exec): TASK [Gathering Facts]   
 ************************************
 null_resource.MySQLRemote[0] (remote-exec): success
 null_resource.MySQLRemote[1] (local-exec): ok: [130.61.159.77]

 null_resource.MySQLRemote[1] (local-exec): TASK [Set discovered Ansible  Python interpreter.] 
 ************************************
 null_resource.MySQLRemote[1] (local-exec): ok: [130.61.159.77]

 null_resource.MySQLRemote[1] (local-exec): TASK [install latest version of mysql] 
 ************************************
 null_resource.MySQLRemote[0] (remote-exec): success
 null_resource.MySQLRemote[0] (remote-exec): success
 null_resource.MySQLRemote[0]: Provisioning with 'local-exec'...
 null_resource.MySQLRemote[0] (local-exec): 
 Executing: ["/bin/sh" "-c" "ansible-playbook -i '158.101.166.99,' --private-key /root/.ssh/id_rsa mysql.yml  -u ubuntu"]

 null_resource.MySQLRemote[0] (local-exec): PLAY [all]   
************************************

 null_resource.MySQLRemote[0] (local-exec): TASK [Gathering Facts]  
 ************************************
 null_resource.MySQLRemote[0] (local-exec): ok: [158.101.166.99]

 null_resource.MySQLRemote[0] (local-exec): TASK [Set discovered Ansible Python interpreter.]  
 ************************************
 null_resource.MySQLRemote[0] (local-exec): ok: [158.101.166.99]

 null_resource.MySQLRemote[0] (local-exec): TASK [install latest version of mysql]  ************************************
 null_resource.MySQLRemote[0]: Still creating... [1m20s elapsed]
[.........snip...............]
 null_resource.MySQLRemote[0]: Still creating... [1m50s elapsed]
 null_resource.MySQLRemote[1]: Still creating... [1m50s elapsed]
 null_resource.MySQLRemote[1] (local-exec): changed: [130.61.159.77]

 null_resource.MySQLRemote[1] (local-exec): TASK [install essentials for  MySQL]
 ************************************
 null_resource.MySQLRemote[0]: Still creating... [2m0s elapsed]
[.........snip...............]
 null_resource.MySQLRemote[0]: Still creating... [2m30s elapsed]
 null_resource.MySQLRemote[1]: Still creating... [2m30s elapsed]
 null_resource.MySQLRemote[0] (local-exec): changed: [158.101.166.99]

 null_resource.MySQLRemote[0] (local-exec): TASK [install essentials for  MySQL]
 ************************************
 null_resource.MySQLRemote[1] (local-exec): changed: [130.61.159.77]

 null_resource.MySQLRemote[1] (local-exec): PLAY RECAP
 ************************************
 null_resource.MySQLRemote[1] (local-exec): 130.61.159.77              : 
ok=4    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

 null_resource.MySQLRemote[1]: Creation complete after 2m32s [id=5662797206597306671]
 null_resource.MySQLRemote[0]: Still creating... [2m40s elapsed]
[.........snip...............]
 null_resource.MySQLRemote[0]: Still creating... [4m40s elapsed]
 null_resource.MySQLRemote[0]: Still creating... [4m50s elapsed]
 null_resource.MySQLRemote[0] (local-exec): changed: [158.101.166.99]

 null_resource.MySQLRemote[0] (local-exec): PLAY RECAP
 ************************************
 null_resource.MySQLRemote[0] (local-exec): 158.101.166.99             : 
ok=4    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

 null_resource.MySQLRemote[0]: Creation complete after 4m56s [id=2412340780357828263]
[.... snip .... ] 

</code>
</pre>
</figure>
 
 <br><br>
<h2> Prepare your local environment for further changes on the remote hosts </h2>
<br><br>
 
 
 <p> File output.tf will extract details as hostname and Public IP of the recently deployed instances</p>
 <br>
<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">


root@deploymentmachine:/home/Tutorial1# more output.tf
output "MySQL-0" {
  value = data.oci_core_vnic.MySQLVNICprimary[0].public_ip_address
}

output "MySQL-1" {
  value = data.oci_core_vnic.MySQLVNICprimary[1].public_ip_address
}
 </code>
 </pre>
 </figure>
 
There is also a small script that is using the "terraform output" command, which will help you configure the SSH access from your local host to the remote hosts:

<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">
root@deploymentmachine:/home/Tutorial1# more run.sh
#!/bin/bash

terraform output | sed 's/"//g' | awk {'print $3,$1'} >> /etc/hosts
</code></pre></figure>

<br>
Let's run it, and then check if the /etc/hosts was populated with new entries:
<br>
<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">
root@deploymentmachine:/home/Tutorial1# ./run.sh
root@deploymentmachine:/home/Tutorial1#
root@deploymentmachine:/home/Tutorial1# more /etc/hosts | grep My*
158.101.166.99 MySQL-0
130.61.159.77 MySQL-1
</code>
</pre>
</figure>

A small manual task required from your side... just populate the /etc/ansible/hosts file with the following entries:

<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">
root@deploymentmachine:/home/tests/terra/test9# more /etc/ansible/hosts | grep My*
MySQL-0 
MySQL-1 
</code>
</pre>
</figure>


<br><br>

And let's make a small test  to see if your configurations are working as expected: 
<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">
root@deploymentmachine:/home/Tutorial1# ansible all -m ping -u ubuntu
MySQL-0 | SUCCESS => {
    "changed": false,
    "ping": "pong"
}
MySQL-1 | SUCCESS => {
    "changed": false,
    "ping": "pong"
}
</code>
</pre>
</figure>


<h2> Testing your new OCI environment with MySQL master-slave replication </h2>

Let us recall what we have done so far:

- we have deployed a compartment with 2 OCI instances of same configuration
- we have configured MySQL service on both instances with the help of Ansible
- we have configured and tested the local environment to see if we can perform other future Ansible tasks on the remote hosts


The next step is to create a MySQL replication master-slave with the ansible playbook, replication.yml:

<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">

root@deploymentmachine:/home/Tutorial1# ansible-playbook -i '158.101.166.99,130.61.159.77'  --private-key /root/.ssh/id_rsa replication.yml -u ubuntu

</code></pre></figure>
<br>

Once you fix a couple of replication errors (Troubleshooting section is included), you should have the following output when checking the master slave:<br>

<h2> Output </h2>



<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">
mysql> show slave status \G;
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 130.61.159.77
                  Master_User: replicauser
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: binlog.000004
          Read_Master_Log_Pos: 1945
               Relay_Log_File: mysql-0-relay-bin.000007
                Relay_Log_Pos: 244
        Relay_Master_Log_File: binlog.000004
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB:
          Replicate_Ignore_DB:
           Replicate_Do_Table:
       Replicate_Ignore_Table:
      Replicate_Wild_Do_Table:
  Replicate_Wild_Ignore_Table:
                   Last_Errno: 0
                   Last_Error:
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 1945
              Relay_Log_Space: 543
              Until_Condition: None
               Until_Log_File:
                Until_Log_Pos: 0
           Master_SSL_Allowed: No
           Master_SSL_CA_File:
           Master_SSL_CA_Path:
              Master_SSL_Cert:
            Master_SSL_Cipher:
               Master_SSL_Key:
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error:
               Last_SQL_Errno: 0
               Last_SQL_Error:
  Replicate_Ignore_Server_Ids:
             Master_Server_Id: 2
                  Master_UUID: 51bc43a9-72d8-11eb-902d-02001702c9ff
             Master_Info_File: mysql.slave_master_info
                    SQL_Delay: 0
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates
           Master_Retry_Count: 86400
                  Master_Bind:
      Last_IO_Error_Timestamp:
     Last_SQL_Error_Timestamp:
               Master_SSL_Crl:
           Master_SSL_Crlpath:
           Retrieved_Gtid_Set:
            Executed_Gtid_Set:
                Auto_Position: 0
         Replicate_Rewrite_DB:
                 Channel_Name:
           Master_TLS_Version:
       Master_public_key_path:
        Get_master_public_key: 0
            Network_Namespace:
1 row in set, 1 warning (0.00 sec)

ERROR:
No query specified

mysql>
</code>
</pre>
</figure>
 
 <br> </br>


<h2>1. Troubleshooting for possible errors: </h2>

Several scenarios when checking the status of your cluster:

<h4> a)  Authentication plugin 'caching_sha2_password' reported error </h4>

<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">
[.... snip .... ]
      Last_IO_Error: error connecting to master 'replicauser@130.61.159.77:3306' 
      - retry-time: 60 retries: 
      9 message: Authentication plugin 'caching_sha2_password' reported error: 
      Authentication requires secure connection.
[.... snip .... ] 
</code></pre></figure>
<br></br>

<b> &nbsp; Explanation </b>

<p>&nbsp; TLS verification by authenticating user with mysql_native_password</p>


<b> &nbsp; Solving this (according to this scenario): </b>


<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">
mysql> ALTER USER 'replicauser'@'%' IDENTIFIED WITH mysql_native_password BY 'str0nkpassw0rd';
Query OK, 0 rows affected (0.01 sec)

mysql> flush privileges;
Query OK, 0 rows affected (0.00 sec)
</code></pre></figure>

<br></br>

<h4> b) Master and slave have equal MySQL server ids </h4>

<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">
[.... snip .... ]
      Last_IO_Error: Fatal error: 
      The slave I/O thread stops because master and slave have equal MySQL server ids; 
      these ids must be different for replication to work 
      (or the --replicate-same-server-id option must be used on slave but this does not always make sense; 
      please check the manual before using it).
[.... snip .... ] 
</code></pre></figure>
<br></br>

<b> &nbsp; Explanation </b>

<p> &nbsp; Change the servers IDs </p>
<br></br>
<b> &nbsp; Solving this (according to this scenario): </b>
<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">
 root@mysql-1:~# mysql -uroot -p
 Enter password:
 Welcome to the MySQL monitor.  Commands end with ; or \g.
 Your MySQL connection id is 33
 Server version: 8.0.23-0ubuntu0.20.04.1 (Ubuntu)


 mysql> stop slave;
 Query OK, 0 rows affected, 1 warning (0.00 sec)

 mysql>  set global server_id=2;
 Query OK, 0 rows affected (0.00 sec)

 mysql> show variables like 'server_id';
 +---------------+-------+
 | Variable_name | Value |
 +---------------+-------+
 | server_id     | 2     |
 +---------------+-------+
 1 row in set (0.00 sec)

 mysql> start slave;
 Query OK, 0 rows affected, 1 warning (0.00 sec)

</code></pre></figure>
 

 



<br> </br>


<h2> 4. Destroying the environment </h2>
<figure class="highlight">
<pre style="color:#f8f8f2;background-color:#234235;-moz-tab-size:4;-o-tab-size:4;tab-size:4; overflow-x:scroll;overflow-y:hidden">
<code class="language-bash" data-lang="bash">
root@deploymentmachine:/home/tests/terra/test8# terraform destroy

An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  - destroy

[ ........... snip .................]


  Enter a value: yes

null_resource.MySQLRemote[0]: Destroying... [id=2418263]
null_resource.MySQLRemote[1]: Destroying... [id=5606671]
null_resource.MySQLRemote[0]: Destruction complete after 0s
null_resource.MySQLRemote[1]: Destruction complete after 0s
oci_core_instance.MySQLInstance[0]: Destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.thel]
oci_core_instance.MySQLInstance[1]: Destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.thel]
oci_core_instance.MySQLInstance[0]: Still destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.anthe...d, 10s elapsed]
oci_core_instance.MySQLInstance[1]: Still destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.anthe...z, 10s elapsed]
oci_core_instance.MySQLInstance[0]: Still destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.anthe...d, 20s elapsed]
oci_core_instance.MySQLInstance[1]: Still destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.anthe...z, 20s elapsed]
oci_core_instance.MySQLInstance[0]: Still destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.anthe...d, 30s elapsed]
oci_core_instance.MySQLInstance[1]: Still destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.anthe...z, 30s elapsed]
oci_core_instance.MySQLInstance[0]: Still destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.anthe...d, 40s elapsed]
oci_core_instance.MySQLInstance[1]: Still destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.anthe...z, 40s elapsed]
oci_core_instance.MySQLInstance[0]: Still destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.anthe...d, 50s elapsed]
oci_core_instance.MySQLInstance[1]: Still destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.anthe...z, 50s elapsed]
oci_core_instance.MySQLInstance[0]: Still destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.anthe...d, 1m0s elapsed]
oci_core_instance.MySQLInstance[1]: Still destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.anthe...z, 1m0s elapsed]
oci_core_instance.MySQLInstance[0]: Still destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.anthe...d, 1m10s elapsed]
oci_core_instance.MySQLInstance[1]: Still destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.anthe...z, 1m10s elapsed]
oci_core_instance.MySQLInstance[0]: Still destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.anthe...d, 1m20s elapsed]
oci_core_instance.MySQLInstance[1]: Still destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.anthe...z, 1m20s elapsed]
oci_core_instance.MySQLInstance[0]: Still destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.anthe...d, 1m30s elapsed]
oci_core_instance.MySQLInstance[1]: Still destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.anthe...z, 1m30s elapsed]
oci_core_instance.MySQLInstance[0]: Destruction complete after 1m34s
oci_core_instance.MySQLInstance[1]: Still destroying... [id=ocid1.instance.oc1.eu-frankfurt-1.anthe...z, 1m40s elapsed]
oci_core_instance.MySQLInstance[1]: Destruction complete after 1m44s
oci_core_subnet.MySQLSubnet: Destroying... [id=ocid1.subnet.oc1.eu-frankfurt-1.a]
oci_core_subnet.MySQLSubnet: Destruction complete after 1s
oci_core_security_list.MySQLSecurityList: Destroying... [id=ocid1.securitylist.oc1.eu-frankfurt-1.aq]
oci_core_route_table.MySQLRouteTable: Destroying... [id=ocid1.routetable.oc1.eu-frankfurt-1.afa]
oci_core_dhcp_options.MySQLDHCPOptions: Destroying... [id=ocid1.dhcpoptions.oc1.eu-frankfurt-1.a7a]
oci_core_dhcp_options.MySQLDHCPOptions: Destruction complete after 0s
oci_core_security_list.MySQLSecurityList: Destruction complete after 0s
oci_core_route_table.MySQLRouteTable: Destruction complete after 0s
oci_core_internet_gateway.MySQLInternetGateway: Destroying... [id=ocid1.internetgateway.oc1.eu-frankfurt-1.aaza]
oci_core_internet_gateway.MySQLInternetGateway: Destruction complete after 0s
oci_core_virtual_network.MySQLVCN: Destroying... [id=ocid1.vcn.oc1.eu-frankfurt-1.auq]
oci_core_virtual_network.MySQLVCN: Destruction complete after 0s
oci_identity_compartment.MySQLCompartment: Destroying... [id=ocid1.compartment.oc1..ata]
oci_identity_compartment.MySQLCompartment: Destruction complete after 0s

Destroy complete! Resources: 11 destroyed.

</code></pre></figure>

<hr>

  </br>
  <span class="post-date">23rd of February, 2021</span>
  </br></br>
<h4>For more technical details and examples which are related to Oracle Cloud, </br>
feel free to check my  <a href="https://isaac-exe.gitbook.io/various-tutorials/">Gitbook</a>.</h4>

</div>

<div class="related">
  <h2>Related Tutorials</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="#Soon">
            This 1st post... more to come... 
            <small> </small>
          </a>
        </h3>
      </li>

    
  </ul>
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>


</body>
</html> 

